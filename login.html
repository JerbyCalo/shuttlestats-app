<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ShuttleStats - Login</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
      .auth-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
      }

      .auth-card {
        background: white;
        border-radius: 16px;
        padding: 40px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 400px;
      }

      .auth-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .auth-header h1 {
        color: #1211ca;
        margin-bottom: 8px;
        font-size: 2rem;
        cursor: pointer;
        transition: transform 0.3s ease;
      }

      .auth-header h1:hover {
        transform: scale(1.05);
      }

      /* Logo split colors */
      .logo-shuttle {
        color: #1211ca;
      }

      .logo-stats {
        color: #f9b314;
      }

      .auth-header p {
        color: #64748b;
        margin: 0;
      }

      .auth-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .form-group label {
        font-weight: 600;
        color: #374151;
      }

      .form-group input {
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.2s;
      }

      .form-group input:focus {
        outline: none;
        border-color: #1211ca;
      }

      .auth-btn {
        padding: 12px 24px;
        background: #1211ca;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .auth-btn:hover {
        background: #0f0fb3;
      }

      .auth-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }

      .google-btn {
        background: white;
        color: #374151;
        border: 2px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
      }

      .google-btn:hover {
        background: #f9fafb;
        border-color: #d1d5db;
      }

      .auth-divider {
        display: flex;
        align-items: center;
        margin: 20px 0;
      }

      .auth-divider::before,
      .auth-divider::after {
        content: "";
        flex: 1;
        height: 1px;
        background: #e5e7eb;
      }

      .auth-divider span {
        padding: 0 16px;
        color: #6b7280;
        font-size: 14px;
      }

      .auth-switch {
        text-align: center;
        margin-top: 20px;
        color: #6b7280;
      }

      .auth-switch a {
        color: #1211ca;
        text-decoration: none;
        font-weight: 600;
      }

      .auth-switch a:hover {
        text-decoration: underline;
      }

      .error-message {
        background: #fef2f2;
        color: #dc2626;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #fecaca;
        font-size: 14px;
      }

      .success-message {
        background: #f0fdf4;
        color: #16a34a;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #bbf7d0;
        font-size: 14px;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #ffffff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Role and Coach Selection Styles */
      .role-selection {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }

      .role-option {
        flex: 1;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
      }

      .role-option:hover {
        border-color: #1211ca;
        background: #f8f9ff;
      }

      .role-option.selected {
        border-color: #1211ca;
        background: #1211ca;
        color: white;
      }

      .coach-selection {
        margin-top: 15px;
      }

      .coach-options {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }

      .coach-option {
        flex: 1;
        padding: 8px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 6px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        font-size: 14px;
      }

      .coach-option:hover {
        border-color: #1211ca;
        background: #f8f9ff;
      }

      .coach-option.selected {
        border-color: #1211ca;
        background: #1211ca;
        color: white;
      }

      /* Enhanced Loading and Toast Styles */
      .auth-btn {
        position: relative;
        overflow: hidden;
      }

      .auth-btn.loading {
        opacity: 0.7;
        cursor: not-allowed;
        pointer-events: none;
      }

      .auth-btn.loading .btn-text {
        opacity: 0;
      }

      .auth-btn.loading::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 16px;
        height: 16px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Form Validation */
      .form-group input.error {
        border-color: #ef4444;
        background-color: #fef2f2;
      }

      .form-group input.success {
        border-color: #10b981;
        background-color: #f0fdf4;
      }

      .field-error {
        color: #ef4444;
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: none;
      }

      .field-error.show {
        display: block;
      }

      /* Mobile Responsiveness */
      @media (max-width: 768px) {
        .auth-container {
          padding: 10px;
          min-height: 100vh;
        }

        .auth-card {
          padding: 30px 20px;
          margin: 10px;
          border-radius: 12px;
          max-width: none;
          width: calc(100% - 20px);
        }

        .auth-header h1 {
          font-size: 2rem;
        }

        .auth-header p {
          font-size: 0.9rem;
        }

        .form-group {
          margin-bottom: 18px;
        }

        .form-group input {
          padding: 14px 16px;
          font-size: 16px; /* Prevents zoom on iOS */
        }

        .auth-btn {
          padding: 14px;
          font-size: 16px;
        }

        .role-selection {
          gap: 12px;
        }

        .role-option {
          padding: 15px;
        }

        .role-option h3 {
          font-size: 1rem;
        }

        .role-option p {
          font-size: 0.8rem;
        }

        /* Toast notifications adjustment for mobile */
        .toast-container {
          padding: 10px;
        }

        .toast {
          margin-bottom: 8px;
          padding: 12px 16px;
          font-size: 0.9rem;
        }
      }

      @media (max-width: 480px) {
        .auth-card {
          padding: 25px 15px;
          margin: 5px;
        }

        .role-selection {
          flex-direction: column;
          gap: 10px;
        }

        .role-option {
          width: 100%;
        }
      }

      /* Password Security Features */
      .password-input-container {
        position: relative;
      }

      .password-toggle {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        color: #6b7280;
        font-size: 18px;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .password-toggle:hover {
        color: #374151;
      }

      .password-strength-container {
        margin-top: 8px;
      }

      .password-strength-bar {
        width: 100%;
        height: 4px;
        background: #e5e7eb;
        border-radius: 2px;
        overflow: hidden;
        margin-bottom: 8px;
      }

      .password-strength-fill {
        height: 100%;
        transition: all 0.3s ease;
        border-radius: 2px;
      }

      .strength-weak {
        width: 25%;
        background: #ef4444;
      }

      .strength-fair {
        width: 50%;
        background: #f59e0b;
      }

      .strength-good {
        width: 75%;
        background: #3b82f6;
      }

      .strength-strong {
        width: 100%;
        background: #10b981;
      }

      .password-requirements {
        font-size: 0.875rem;
        color: #6b7280;
      }

      .requirement {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
      }

      .requirement-icon {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: bold;
      }

      .requirement-met {
        background: #10b981;
        color: white;
      }

      .requirement-unmet {
        background: #e5e7eb;
        color: #9ca3af;
      }

      .strength-text {
        font-size: 0.875rem;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .strength-weak-text {
        color: #ef4444;
      }
      .strength-fair-text {
        color: #f59e0b;
      }
      .strength-good-text {
        color: #3b82f6;
      }
      .strength-strong-text {
        color: #10b981;
      }

      /* Forgot Password Link */
      .forgot-password {
        text-align: center;
        margin-top: 16px;
      }

      .forgot-password a {
        color: #1211ca;
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
      }

      .forgot-password a:hover {
        text-decoration: underline;
      }

      /* Remember Me */
      .remember-me {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 16px 0;
        font-size: 0.875rem;
        color: #374151;
      }

      .remember-me input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: #1211ca;
      }
    </style>
  </head>
  <body>
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-header">
          <h1 id="logoHeader" onclick="window.location.href='index.html'">
            üè∏ <span class="logo-shuttle">Shuttle</span
            ><span class="logo-stats">Stats</span>
          </h1>
          <p id="authSubtitle">Sign in to your account</p>
        </div>

        <div
          id="errorMessage"
          class="error-message"
          style="display: none"
        ></div>
        <div
          id="successMessage"
          class="success-message"
          style="display: none"
        ></div>

        <form id="authForm" class="auth-form">
          <div class="form-group">
            <label for="email">Email Address</label>
            <input type="email" id="email" name="email" required />
            <div class="field-error" id="emailError"></div>
          </div>

          <div class="form-group">
            <label for="password">Password</label>
            <div class="password-input-container">
              <input type="password" id="password" name="password" required />
              <button type="button" class="password-toggle" id="passwordToggle">
                üëÅÔ∏è
              </button>
            </div>
            <div
              class="password-strength-container"
              id="passwordStrengthContainer"
              style="display: none"
            >
              <div class="strength-text" id="strengthText"></div>
              <div class="password-strength-bar">
                <div class="password-strength-fill" id="strengthFill"></div>
              </div>
              <div class="password-requirements" id="passwordRequirements">
                <div class="requirement" id="lengthReq">
                  <span class="requirement-icon requirement-unmet">‚úì</span>
                  <span>At least 6 characters</span>
                </div>
                <div class="requirement" id="uppercaseReq">
                  <span class="requirement-icon requirement-unmet">‚úì</span>
                  <span>One uppercase letter</span>
                </div>
                <div class="requirement" id="numberReq">
                  <span class="requirement-icon requirement-unmet">‚úì</span>
                  <span>One number</span>
                </div>
              </div>
            </div>
            <div class="field-error" id="passwordError"></div>
          </div>

          <div
            class="form-group"
            id="confirmPasswordGroup"
            style="display: none"
          >
            <label for="confirmPassword">Confirm Password</label>
            <div class="password-input-container">
              <input
                type="password"
                id="confirmPassword"
                name="confirmPassword"
              />
              <button
                type="button"
                class="password-toggle"
                id="confirmPasswordToggle"
              >
                üëÅÔ∏è
              </button>
            </div>
            <div class="field-error" id="confirmPasswordError"></div>
          </div>

          <!-- Role Selection for Signup -->
          <div class="form-group" id="roleSelectionGroup" style="display: none">
            <label>I am a:</label>
            <div class="role-selection">
              <div class="role-option" id="playerOption" data-role="player">
                üè∏ Player
              </div>
              <div class="role-option" id="coachOption" data-role="coach">
                üë®‚Äçüè´ Coach
              </div>
            </div>
          </div>

          <!-- Coach Selection for Players -->
          <div
            class="form-group"
            id="coachSelectionGroup"
            style="display: none"
          >
            <label>Do you have a coach?</label>
            <div class="coach-options">
              <div class="coach-option" id="hasCoachOption" data-coach="yes">
                Yes, I have a coach
              </div>
              <div class="coach-option" id="soloOption" data-coach="no">
                I train solo
              </div>
            </div>
            <div id="coachNameGroup" style="display: none; margin-top: 15px">
              <label for="coachName">Coach Name</label>
              <input
                type="text"
                id="coachName"
                name="coachName"
                placeholder="Enter your coach's name"
              />
              <div class="field-error" id="coachNameError"></div>
            </div>
          </div>

          <!-- Remember Me (only for sign in) -->
          <div class="remember-me" id="rememberMeGroup">
            <input type="checkbox" id="rememberMe" name="rememberMe" />
            <label for="rememberMe">Remember me</label>
          </div>

          <button type="submit" id="authSubmitBtn" class="auth-btn">
            <span id="authBtnText" class="btn-text">Sign In</span>
            <span
              id="authBtnLoading"
              class="loading-spinner"
              style="display: none"
            ></span>
          </button>

          <!-- Forgot Password (only for sign in) -->
          <div class="forgot-password" id="forgotPasswordGroup">
            <a href="#" id="forgotPasswordLink">Forgot your password?</a>
          </div>

          <div class="auth-divider">
            <span>or</span>
          </div>

          <button
            type="button"
            id="googleSignInBtn"
            class="auth-btn google-btn"
          >
            <svg width="20" height="20" viewBox="0 0 24 24">
              <path
                fill="#4285F4"
                d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
              />
              <path
                fill="#34A853"
                d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
              />
              <path
                fill="#FBBC05"
                d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
              />
              <path
                fill="#EA4335"
                d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
              />
            </svg>
            Continue with Google
          </button>
        </form>

        <div class="auth-switch">
          <span id="authSwitchText">Don't have an account?</span>
          <a href="#" id="authSwitchLink">Sign up</a>
        </div>
      </div>
    </div>

    <script type="module">
      try {
        const { authService } = await import("./js/auth-service.js");
        const { ToastManager } = await import("./js/toast.js");

        // Initialize toast manager and make authService globally available
        window.toastManager = new ToastManager();
        window.authService = authService;

        console.log("Auth service loaded:", !!window.authService);
        console.log("Toast manager loaded:", !!window.toastManager);

        // Try to import data service, but don't fail if it's not available
        let dataService = null;
        try {
          const dataServiceModule = await import("./js/data-service.js");
          dataService = dataServiceModule.dataService;
          window.dataService = dataService;
        } catch (dataServiceError) {
          console.warn("Data service not available:", dataServiceError);
        }

        class AuthPage {
          constructor() {
            this.isSignUp = false;
            this.selectedRole = "";
            this.hasCoach = false;
            this.initEventListeners();
            this.initRoleSelection();
            this.initPasswordSecurity();
            this.checkAuthState();
          }

          initEventListeners() {
            document
              .getElementById("authForm")
              .addEventListener("submit", this.handleSubmit.bind(this));
            document
              .getElementById("googleSignInBtn")
              .addEventListener("click", this.handleGoogleSignIn.bind(this));
            document
              .getElementById("authSwitchLink")
              .addEventListener("click", this.toggleMode.bind(this));

            // Add real-time validation
            this.setupRealTimeValidation();
          }

          setupRealTimeValidation() {
            const emailField = document.getElementById("email");
            const passwordField = document.getElementById("password");
            const confirmPasswordField =
              document.getElementById("confirmPassword");
            const coachNameField = document.getElementById("coachName");

            // Email validation on blur
            emailField.addEventListener("blur", () => {
              const validation = this.validateEmail(emailField.value.trim());
              if (emailField.value.trim()) {
                if (validation.valid) {
                  this.showFieldSuccess("email");
                } else {
                  this.showFieldError("email", validation.message);
                }
              }
            });

            // Password validation on input
            passwordField.addEventListener("input", () => {
              if (passwordField.value) {
                const validation = this.validatePassword(
                  passwordField.value,
                  this.isSignUp
                );
                if (validation.valid) {
                  this.showFieldSuccess("password");
                } else {
                  this.showFieldError("password", validation.message);
                }

                // Also validate confirm password if it has a value
                if (this.isSignUp && confirmPasswordField.value) {
                  const confirmValidation = this.validateConfirmPassword(
                    passwordField.value,
                    confirmPasswordField.value
                  );
                  if (confirmValidation.valid) {
                    this.showFieldSuccess("confirmPassword");
                  } else {
                    this.showFieldError(
                      "confirmPassword",
                      confirmValidation.message
                    );
                  }
                }
              }
            });

            // Confirm password validation
            confirmPasswordField.addEventListener("input", () => {
              if (confirmPasswordField.value) {
                const validation = this.validateConfirmPassword(
                  passwordField.value,
                  confirmPasswordField.value
                );
                if (validation.valid) {
                  this.showFieldSuccess("confirmPassword");
                } else {
                  this.showFieldError("confirmPassword", validation.message);
                }
              }
            });

            // Coach name validation
            coachNameField.addEventListener("blur", () => {
              if (coachNameField.value.trim()) {
                const validation = this.validateCoachName(
                  coachNameField.value.trim()
                );
                if (validation.valid) {
                  this.showFieldSuccess("coachName");
                } else {
                  this.showFieldError("coachName", validation.message);
                }
              }
            });
          }

          initPasswordSecurity() {
            // Password visibility toggles
            this.initPasswordToggle("password", "passwordToggle");
            this.initPasswordToggle("confirmPassword", "confirmPasswordToggle");

            // Password strength indicator
            const passwordField = document.getElementById("password");
            passwordField.addEventListener("input", () => {
              this.updatePasswordStrength(passwordField.value);
            });

            // Forgot password link
            document
              .getElementById("forgotPasswordLink")
              .addEventListener("click", (e) => {
                e.preventDefault();
                this.handleForgotPassword();
              });
          }

          initPasswordToggle(inputId, toggleId) {
            const input = document.getElementById(inputId);
            const toggle = document.getElementById(toggleId);

            if (toggle) {
              toggle.addEventListener("click", () => {
                const isPassword = input.type === "password";
                input.type = isPassword ? "text" : "password";
                toggle.textContent = isPassword ? "üôà" : "üëÅÔ∏è";
              });
            }
          }

          calculatePasswordStrength(password) {
            let score = 0;
            const requirements = {
              length: password.length >= 6,
              uppercase: /[A-Z]/.test(password),
              number: /[0-9]/.test(password),
            };

            // Score calculation (no symbols required)
            if (requirements.length) score += 1;
            if (requirements.uppercase) score += 1;
            if (requirements.number) score += 1;

            let strength = "weak";
            if (score === 3) strength = "strong";
            else if (score === 2) strength = "good";
            else if (score === 1) strength = "fair";

            return { strength, score, requirements };
          }

          updatePasswordStrength(password) {
            const container = document.getElementById(
              "passwordStrengthContainer"
            );
            const strengthText = document.getElementById("strengthText");
            const strengthFill = document.getElementById("strengthFill");

            // Show/hide strength indicator based on signup mode
            if (this.isSignUp && password.length > 0) {
              container.style.display = "block";

              const { strength, requirements } =
                this.calculatePasswordStrength(password);

              // Update strength text and bar
              strengthText.textContent = `Password strength: ${
                strength.charAt(0).toUpperCase() + strength.slice(1)
              }`;
              strengthText.className = `strength-text strength-${strength}-text`;

              strengthFill.className = `password-strength-fill strength-${strength}`;

              // Update requirements
              this.updateRequirement("lengthReq", requirements.length);
              this.updateRequirement("uppercaseReq", requirements.uppercase);
              this.updateRequirement("numberReq", requirements.number);
            } else {
              container.style.display = "none";
            }
          }

          updateRequirement(reqId, met) {
            const requirement = document.getElementById(reqId);
            const icon = requirement.querySelector(".requirement-icon");

            if (met) {
              icon.classList.remove("requirement-unmet");
              icon.classList.add("requirement-met");
            } else {
              icon.classList.remove("requirement-met");
              icon.classList.add("requirement-unmet");
            }
          }

          handleForgotPassword() {
            const email = document.getElementById("email").value.trim();

            if (!email) {
              window.toastManager.warning(
                "Please enter your email address first"
              );
              document.getElementById("email").focus();
              return;
            }

            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
              window.toastManager.error("Please enter a valid email address");
              document.getElementById("email").focus();
              return;
            }

            this.sendPasswordReset(email);
          }

          async sendPasswordReset(email) {
            try {
              // Note: This will need to be implemented in auth-service.js
              if (window.authService.sendPasswordReset) {
                const result = await window.authService.sendPasswordReset(
                  email
                );
                if (result.success) {
                  window.toastManager.success(
                    `Password reset email sent to ${email}`
                  );
                } else {
                  window.toastManager.error(
                    result.error || "Failed to send reset email"
                  );
                }
              } else {
                window.toastManager.info(
                  "Password reset feature will be available soon"
                );
              }
            } catch (error) {
              console.error("Password reset error:", error);
              window.toastManager.error("Failed to send password reset email");
            }
          }

          initRoleSelection() {
            // Role selection handlers
            document
              .getElementById("playerOption")
              .addEventListener("click", () => {
                this.selectRole("player");
              });

            document
              .getElementById("coachOption")
              .addEventListener("click", () => {
                this.selectRole("coach");
              });

            // Coach selection handlers
            document
              .getElementById("hasCoachOption")
              .addEventListener("click", () => {
                this.selectCoachOption(true);
              });

            document
              .getElementById("soloOption")
              .addEventListener("click", () => {
                this.selectCoachOption(false);
              });
          }

          selectRole(role) {
            this.selectedRole = role;

            // Update UI
            document.querySelectorAll(".role-option").forEach((option) => {
              option.classList.remove("selected");
            });
            document.getElementById(role + "Option").classList.add("selected");

            // Show/hide coach selection based on role
            const coachSelectionGroup = document.getElementById(
              "coachSelectionGroup"
            );
            if (role === "player") {
              coachSelectionGroup.style.display = "flex";
            } else {
              coachSelectionGroup.style.display = "none";
              this.hasCoach = false;
              document.getElementById("coachNameGroup").style.display = "none";
            }
          }

          selectCoachOption(hasCoach) {
            this.hasCoach = hasCoach;

            // Update UI
            document.querySelectorAll(".coach-option").forEach((option) => {
              option.classList.remove("selected");
            });

            if (hasCoach) {
              document
                .getElementById("hasCoachOption")
                .classList.add("selected");
              document.getElementById("coachNameGroup").style.display = "block";
            } else {
              document.getElementById("soloOption").classList.add("selected");
              document.getElementById("coachNameGroup").style.display = "none";
            }
          }

          async checkAuthState() {
            // If user is already authenticated, redirect to dashboard
            if (window.authService.isAuthenticated()) {
              window.location.href = "dashboard.html";
            }
          }

          async handleSubmit(e) {
            e.preventDefault();
            this.hideMessages();

            console.log("Form submitted, starting validation...");

            // Validate form using comprehensive validation
            if (!this.validateForm()) {
              console.log("Form validation failed");
              return;
            }

            console.log("Form validation passed");

            const email = document.getElementById("email").value.trim();
            const password = document.getElementById("password").value;

            console.log("Email:", email, "Password length:", password.length);

            this.setLoading(true);

            try {
              let result;

              if (this.isSignUp) {
                const role = document.querySelector(
                  'input[name="role"]:checked'
                )?.value;
                const userData = { role: role };

                if (role === "player") {
                  userData.coachName = document
                    .getElementById("coachName")
                    .value.trim();
                }

                result = await window.authService.signUp(
                  email,
                  password,
                  userData
                );
              } else {
                result = await window.authService.signIn(email, password);
              }

              if (result.success) {
                // Set up data service for the user if available
                if (window.dataService) {
                  window.dataService.setCurrentUser(result.user.uid);
                }

                window.toastManager.success(
                  this.isSignUp
                    ? "Account created successfully! Redirecting..."
                    : "Welcome back! Redirecting..."
                );

                // Redirect to dashboard after a short delay
                setTimeout(() => {
                  window.location.href = "dashboard.html";
                }, 1500);
              } else {
                window.toastManager.error(result.error);
              }
            } catch (error) {
              console.error("Authentication error:", error);
              window.toastManager.error(
                "An unexpected error occurred. Please try again."
              );
            } finally {
              this.setLoading(false);
            }
          }

          async handleGoogleSignIn() {
            this.setLoading(true);
            this.hideMessages();

            try {
              const result = await window.authService.signInWithGoogle();

              if (result.success) {
                // Set up data service for the user if available
                if (dataService) {
                  dataService.setCurrentUser(result.user.uid);
                }

                this.showSuccess("Signed in with Google successfully!");

                // Redirect to dashboard after a short delay
                setTimeout(() => {
                  window.location.href = "dashboard.html";
                }, 1000);
              } else {
                this.showError(result.error);
              }
            } catch (error) {
              this.showError("Google sign-in failed. Please try again.");
            } finally {
              this.setLoading(false);
            }
          }

          toggleMode(e) {
            e.preventDefault();
            this.isSignUp = !this.isSignUp;
            this.updateUI();
            this.hideMessages();
          }

          updateUI() {
            const subtitle = document.getElementById("authSubtitle");
            const confirmGroup = document.getElementById(
              "confirmPasswordGroup"
            );
            const roleSelectionGroup =
              document.getElementById("roleSelectionGroup");
            const coachSelectionGroup = document.getElementById(
              "coachSelectionGroup"
            );
            const rememberMeGroup = document.getElementById("rememberMeGroup");
            const forgotPasswordGroup = document.getElementById(
              "forgotPasswordGroup"
            );
            const submitBtn = document.getElementById("authBtnText");
            const switchText = document.getElementById("authSwitchText");
            const switchLink = document.getElementById("authSwitchLink");

            if (this.isSignUp) {
              subtitle.textContent = "Create your account";
              confirmGroup.style.display = "flex";
              roleSelectionGroup.style.display = "flex";
              rememberMeGroup.style.display = "none";
              forgotPasswordGroup.style.display = "none";
              submitBtn.textContent = "Sign Up";
              switchText.textContent = "Already have an account?";
              switchLink.textContent = "Sign in";
            } else {
              subtitle.textContent = "Sign in to your account";
              confirmGroup.style.display = "none";
              roleSelectionGroup.style.display = "none";
              coachSelectionGroup.style.display = "none";
              rememberMeGroup.style.display = "flex";
              forgotPasswordGroup.style.display = "block";
              submitBtn.textContent = "Sign In";
              switchText.textContent = "Don't have an account?";
              switchLink.textContent = "Sign up";

              // Reset selections when switching to login
              this.selectedRole = "";
              this.hasCoach = false;
              document
                .querySelectorAll(".role-option, .coach-option")
                .forEach((option) => {
                  option.classList.remove("selected");
                });
              document.getElementById("coachNameGroup").style.display = "none";
            }
          }

          // Comprehensive Form Validation
          validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!email) {
              return { valid: false, message: "Email is required" };
            }
            if (!emailRegex.test(email)) {
              return {
                valid: false,
                message: "Please enter a valid email address",
              };
            }
            return { valid: true, message: "" };
          }

          validatePassword(password, isSignup = false) {
            if (!password) {
              return { valid: false, message: "Password is required" };
            }

            if (isSignup) {
              // Enhanced validation for signup
              const requirements = [];

              if (password.length < 6) {
                requirements.push("at least 6 characters");
              }
              if (!/[A-Z]/.test(password)) {
                requirements.push("one uppercase letter");
              }
              if (!/[0-9]/.test(password)) {
                requirements.push("one number");
              }

              if (requirements.length > 0) {
                return {
                  valid: false,
                  message: `Password must include ${requirements.join(", ")}`,
                };
              }
            } else {
              // Basic validation for signin
              if (password.length < 6) {
                return {
                  valid: false,
                  message: "Password must be at least 6 characters long",
                };
              }
            }

            return { valid: true, message: "" };
          }

          validateConfirmPassword(password, confirmPassword) {
            if (!confirmPassword) {
              return { valid: false, message: "Please confirm your password" };
            }
            if (password !== confirmPassword) {
              return { valid: false, message: "Passwords do not match" };
            }
            return { valid: true, message: "" };
          }

          validateCoachName(coachName) {
            if (!coachName || coachName.trim() === "") {
              return { valid: false, message: "Coach name is required" };
            }
            if (coachName.trim().length < 2) {
              return {
                valid: false,
                message: "Coach name must be at least 2 characters",
              };
            }
            return { valid: true, message: "" };
          }

          showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(fieldId + "Error");

            if (field && errorDiv) {
              field.classList.add("error");
              field.classList.remove("success");
              errorDiv.textContent = message;
              errorDiv.classList.add("show");
            }
          }

          showFieldSuccess(fieldId) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(fieldId + "Error");

            if (field && errorDiv) {
              field.classList.remove("error");
              field.classList.add("success");
              errorDiv.classList.remove("show");
            }
          }

          clearFieldErrors() {
            const errorDivs = document.querySelectorAll(".field-error");
            const inputFields = document.querySelectorAll(".form-group input");

            errorDivs.forEach((div) => div.classList.remove("show"));
            inputFields.forEach((input) => {
              input.classList.remove("error", "success");
            });
          }

          validateForm() {
            this.clearFieldErrors();
            let isValid = true;
            const isSignupMode = this.isSignUp;

            // Get form values
            const email = document.getElementById("email").value.trim();
            const password = document.getElementById("password").value;
            const confirmPassword =
              document.getElementById("confirmPassword").value;
            const role = this.selectedRole; // Use the selected role from class property
            const coachName = document.getElementById("coachName").value.trim();

            // Validate email
            const emailValidation = this.validateEmail(email);
            if (!emailValidation.valid) {
              this.showFieldError("email", emailValidation.message);
              isValid = false;
            } else {
              this.showFieldSuccess("email");
            }

            // Validate password
            const passwordValidation = this.validatePassword(
              password,
              isSignupMode
            );
            if (!passwordValidation.valid) {
              this.showFieldError("password", passwordValidation.message);
              isValid = false;
            } else {
              this.showFieldSuccess("password");
            }

            // Validate signup-specific fields
            if (isSignupMode) {
              // Validate confirm password
              const confirmPasswordValidation = this.validateConfirmPassword(
                password,
                confirmPassword
              );
              if (!confirmPasswordValidation.valid) {
                this.showFieldError(
                  "confirmPassword",
                  confirmPasswordValidation.message
                );
                isValid = false;
              } else {
                this.showFieldSuccess("confirmPassword");
              }

              // Validate role selection
              if (!role) {
                window.toastManager.error(
                  "Please select your role (Player or Coach)"
                );
                isValid = false;
              }

              // Validate coach name if player role is selected
              if (role === "player") {
                const coachNameValidation = this.validateCoachName(coachName);
                if (!coachNameValidation.valid) {
                  this.showFieldError("coachName", coachNameValidation.message);
                  isValid = false;
                } else {
                  this.showFieldSuccess("coachName");
                }
              }
            }

            return isValid;
          }

          setLoading(loading) {
            const submitBtn = document.getElementById("authSubmitBtn");
            const btnText = document.getElementById("authBtnText");
            const btnLoading = document.getElementById("authBtnLoading");
            const googleBtn = document.getElementById("googleSignInBtn");

            if (loading) {
              submitBtn.disabled = true;
              googleBtn.disabled = true;
              btnText.style.display = "none";
              btnLoading.style.display = "inline-block";
            } else {
              submitBtn.disabled = false;
              googleBtn.disabled = false;
              btnText.style.display = "inline";
              btnLoading.style.display = "none";
            }
          }

          showError(message) {
            const errorDiv = document.getElementById("errorMessage");
            errorDiv.textContent = message;
            errorDiv.style.display = "block";
          }

          showSuccess(message) {
            const successDiv = document.getElementById("successMessage");
            successDiv.textContent = message;
            successDiv.style.display = "block";
          }

          hideMessages() {
            document.getElementById("errorMessage").style.display = "none";
            document.getElementById("successMessage").style.display = "none";
          }
        }

        // Initialize auth page
        console.log("Initializing AuthPage...");
        new AuthPage();
      } catch (error) {
        console.error("Failed to load authentication modules:", error);
        const errorMsg = `Failed to load authentication system: ${error.message}. Please refresh the page.`;
        document.getElementById("errorMessage").textContent = errorMsg;
        document.getElementById("errorMessage").style.display = "block";
      }
    </script>
  </body>
</html>
