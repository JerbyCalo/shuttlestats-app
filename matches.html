<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Matches - ShuttleStats</title>
    <link rel="stylesheet" href="css/dashboard-style.css" />
  <link rel="stylesheet" href="css/matches.css" />
  <link rel="stylesheet" href="css/modal.css" />
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar">
      <div class="nav-container">
  <a href="dashboard.html" class="nav-logo">
          <span class="logo-icon">üè∏</span>
          <span class="logo-text"
            ><span class="logo-shuttle">Shuttle</span
            ><span class="logo-stats">Stats</span></span
          >
  </a>
        <div class="nav-right">
          <div class="user-info">
            <span class="user-name" id="userName">Welcome back!</span>
            <div class="user-dropdown">
              <button class="dropdown-toggle">‚öôÔ∏è</button>
              <div class="dropdown-menu">
                <a href="#profile">Profile</a>
                <a href="#settings">Settings</a>
                <a href="#" id="signOutBtn">Logout</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Matches Content -->
    <main class="dashboard-main">
      <!-- Sidebar Toggle Button -->
      <button class="sidebar-toggle" id="sidebarToggle">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </button>

      <!-- Sidebar Overlay -->
      <div class="sidebar-overlay" id="sidebarOverlay"></div>

      <!-- Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-menu">
          <div class="menu-section">
            <h3>Overview</h3>
            <ul>
              <li>
                <a href="dashboard.html" class="menu-item">üìä Dashboard</a>
              </li>
              <li><a href="training.html" class="menu-item">üèÉ‚Äç‚ôÇÔ∏è Training</a></li>
              <li>
                <a href="matches.html" class="menu-item active">üèÜ Matches</a>
              </li>
              <li><a href="schedule.html" class="menu-item">üìÖ Schedule</a></li>
            </ul>
          </div>
          <div class="menu-section" id="playerSection">
            <h3>Player Tools</h3>
            <ul>
              <li><a href="#progress" class="menu-item">üìà Progress</a></li>
              <li>
                <a href="#achievements" class="menu-item">üéØ Achievements</a>
              </li>
              <li><a href="goals.html" class="menu-item">‚≠ê Goals</a></li>
            </ul>
          </div>
          <div class="menu-section" id="coachSection" style="display: none">
            <h3>Coach Tools</h3>
            <ul>
              <li><a href="#players" class="menu-item">üë• My Players</a></li>
              <li><a href="#plans" class="menu-item">üìã Training Plans</a></li>
              <li><a href="#feedback" class="menu-item">üí¨ Feedback</a></li>
              <li><a href="#reports" class="menu-item">üìä Reports</a></li>
            </ul>
          </div>
        </div>
      </aside>

      <!-- Content Area -->
      <div class="content-area">
        <!-- Matches Header -->
        <div class="content-header">
          <h1>Match Records</h1>
          <p class="current-date" id="currentDate"></p>
        </div>

        <!-- Matches Actions -->
        <div class="matches-actions">
          <button class="btn btn-primary" id="newMatchBtn">
            <span class="btn-icon">üèÜ</span>
            Record New Match
          </button>
          <button class="btn btn-secondary" id="viewHistoryBtn">
            <span class="btn-icon">üìä</span>
            View History
          </button>
          <button class="btn btn-secondary" id="analysisBtn">
            <span class="btn-icon">üìà</span>
            Performance Analysis
          </button>
          <button class="btn btn-secondary" id="exportDataBtn">
            <span class="btn-icon">üì§</span>
            Export Data
          </button>
        </div>

        <!-- Match Stats Overview -->
        <div class="match-stats">
          <div class="stat-card win">
            <div class="stat-icon">üèÜ</div>
            <div class="stat-info">
              <span class="stat-number loading" id="totalWins">...</span>
              <span class="stat-label">Wins</span>
            </div>
          </div>
          <div class="stat-card loss">
            <div class="stat-icon">üòû</div>
            <div class="stat-info">
              <span class="stat-number loading" id="totalLosses">...</span>
              <span class="stat-label">Losses</span>
            </div>
          </div>
          <div class="stat-card ratio">
            <div class="stat-icon">üìä</div>
            <div class="stat-info">
              <span class="stat-number loading" id="winRatio">...</span>
              <span class="stat-label">Win Rate</span>
            </div>
          </div>
          <div class="stat-card streak">
            <div class="stat-icon">üî•</div>
            <div class="stat-info">
              <span class="stat-number loading" id="currentStreak">...</span>
              <span class="stat-label">Current Streak</span>
            </div>
          </div>
        </div>

        <!-- Match Content Sections -->
        <div class="match-content">
          <!-- Match Recording Form (now in modal) -->
          <div id="matchFormModal" class="modal" style="display:none">
            <div class="modal-content">
              <div class="modal-header">
                <h2>Record Match</h2>
                <button class="close" id="closeMatchForm">&times;</button>
              </div>
              <div class="modal-body">
              <form id="matchRecordForm" class="match-form">
                <!-- Basic Match Information -->
                <div class="form-section">
                  <h3>Match Details</h3>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="matchDate">Date</label>
                      <input type="date" id="matchDate" name="date" required />
                    </div>
                    <div class="form-group">
                      <label for="matchType">Match Type</label>
                      <select id="matchType" name="type" required>
                        <option value="">Select type</option>
                        <option value="singles">Singles</option>
                        <option value="doubles">Doubles</option>
                        <option value="mixed-doubles">Mixed Doubles</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="opponent">Opponent(s)</label>
                      <input
                        type="text"
                        id="opponent"
                        name="opponent"
                        placeholder="Enter opponent name(s)"
                        required
                      />
                    </div>
                    <div class="form-group">
                      <label for="venue">Venue</label>
                      <input
                        type="text"
                        id="venue"
                        name="venue"
                        placeholder="e.g., City Sports Center"
                      />
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="tournament">Tournament/Event</label>
                      <input
                        type="text"
                        id="tournament"
                        name="tournament"
                        placeholder="Optional: Tournament name"
                      />
                    </div>
                    <div class="form-group">
                      <label for="matchDuration">Duration (minutes)</label>
                      <input
                        type="number"
                        id="matchDuration"
                        name="duration"
                        min="1"
                        max="300"
                      />
                    </div>
                  </div>
                </div>

                <!-- Score Recording -->
                <div class="form-section">
                  <h3>Match Score</h3>
                  <div class="score-section">
                    <div class="set-scores">
                      <!-- Set 1 -->
                      <div class="set-score">
                        <h4>Set 1</h4>
                        <div class="score-input">
                          <label>You</label>
                          <input
                            type="number"
                            name="yourSet1"
                            min="0"
                            max="30"
                            required
                          />
                          <span>-</span>
                          <input
                            type="number"
                            name="oppSet1"
                            min="0"
                            max="30"
                            required
                          />
                          <label>Opponent</label>
                        </div>
                      </div>

                      <!-- Set 2 -->
                      <div class="set-score">
                        <h4>Set 2</h4>
                        <div class="score-input">
                          <label>You</label>
                          <input
                            type="number"
                            name="yourSet2"
                            min="0"
                            max="30"
                            required
                          />
                          <span>-</span>
                          <input
                            type="number"
                            name="oppSet2"
                            min="0"
                            max="30"
                            required
                          />
                          <label>Opponent</label>
                        </div>
                      </div>

                      <!-- Set 3 (Optional) -->
                      <div class="set-score">
                        <h4>Set 3 (if played)</h4>
                        <div class="score-input">
                          <label>You</label>
                          <input
                            type="number"
                            name="yourSet3"
                            min="0"
                            max="30"
                          />
                          <span>-</span>
                          <input
                            type="number"
                            name="oppSet3"
                            min="0"
                            max="30"
                          />
                          <label>Opponent</label>
                        </div>
                      </div>
                    </div>

                    <div class="match-result" id="matchResult">
                      <span class="result-text"
                        >Enter scores to see result</span
                      >
                    </div>
                  </div>
                </div>

                <!-- Error Statistics -->
                <div class="form-section">
                  <h3>Error Statistics</h3>
                  <div class="error-stats-grid">
                    <div class="error-category">
                      <h4>Unforced Errors</h4>
                      <div class="error-inputs">
                        <div class="error-input">
                          <label>Net Errors</label>
                          <input
                            type="number"
                            name="netErrors"
                            min="0"
                            value="0"
                          />
                        </div>
                        <div class="error-input">
                          <label>Out Shots</label>
                          <input
                            type="number"
                            name="outErrors"
                            min="0"
                            value="0"
                          />
                        </div>
                        <div class="error-input">
                          <label>Lift Errors</label>
                          <input
                            type="number"
                            name="liftErrors"
                            min="0"
                            value="0"
                          />
                        </div>
                      </div>
                    </div>

                    <div class="error-category">
                      <h4>Service Errors</h4>
                      <div class="error-inputs">
                        <div class="error-input">
                          <label>Service Faults</label>
                          <input
                            type="number"
                            name="serviceFaults"
                            min="0"
                            value="0"
                          />
                        </div>
                        <div class="error-input">
                          <label>Double Faults</label>
                          <input
                            type="number"
                            name="doubleFaults"
                            min="0"
                            value="0"
                          />
                        </div>
                      </div>
                    </div>

                    <div class="error-category">
                      <h4>Winners & Points</h4>
                      <div class="error-inputs">
                        <div class="error-input">
                          <label>Smash Winners</label>
                          <input
                            type="number"
                            name="smashWinners"
                            min="0"
                            value="0"
                          />
                        </div>
                        <div class="error-input">
                          <label>Drop Winners</label>
                          <input
                            type="number"
                            name="dropWinners"
                            min="0"
                            value="0"
                          />
                        </div>
                        <div class="error-input">
                          <label>Service Aces</label>
                          <input
                            type="number"
                            name="serviceAces"
                            min="0"
                            value="0"
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Performance Assessment -->
                <div class="form-section">
                  <h3>Performance Analysis</h3>
                  <div class="performance-grid">
                    <div class="performance-category">
                      <h4>Stroke Quality</h4>
                      <div class="rating-group">
                        <div class="rating-item">
                          <label>Forehand</label>
                          <div class="rating-input">
                            <input
                              type="range"
                              name="forehandRating"
                              min="1"
                              max="10"
                              value="5"
                            />
                            <span class="rating-value">5</span>
                          </div>
                        </div>
                        <div class="rating-item">
                          <label>Backhand</label>
                          <div class="rating-input">
                            <input
                              type="range"
                              name="backhandRating"
                              min="1"
                              max="10"
                              value="5"
                            />
                            <span class="rating-value">5</span>
                          </div>
                        </div>
                        <div class="rating-item">
                          <label>Serving</label>
                          <div class="rating-input">
                            <input
                              type="range"
                              name="servingRating"
                              min="1"
                              max="10"
                              value="5"
                            />
                            <span class="rating-value">5</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="performance-category">
                      <h4>Game Aspects</h4>
                      <div class="rating-group">
                        <div class="rating-item">
                          <label>Footwork</label>
                          <div class="rating-input">
                            <input
                              type="range"
                              name="footworkRating"
                              min="1"
                              max="10"
                              value="5"
                            />
                            <span class="rating-value">5</span>
                          </div>
                        </div>
                        <div class="rating-item">
                          <label>Strategy</label>
                          <div class="rating-input">
                            <input
                              type="range"
                              name="strategyRating"
                              min="1"
                              max="10"
                              value="5"
                            />
                            <span class="rating-value">5</span>
                          </div>
                        </div>
                        <div class="rating-item">
                          <label>Mental Game</label>
                          <div class="rating-input">
                            <input
                              type="range"
                              name="mentalRating"
                              min="1"
                              max="10"
                              value="5"
                            />
                            <span class="rating-value">5</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Match Notes -->
                <div class="form-section">
                  <h3>Match Analysis</h3>
                  <div class="form-group">
                    <label for="matchNotes"
                      >What worked well? What needs improvement?</label
                    >
                    <textarea
                      id="matchNotes"
                      name="notes"
                      rows="4"
                      placeholder="Describe key moments, strategies that worked, areas for improvement..."
                    ></textarea>
                  </div>
                  <div class="form-group">
                    <label for="nextFocus">Focus for Next Match</label>
                    <textarea
                      id="nextFocus"
                      name="nextFocus"
                      rows="2"
                      placeholder="What will you work on before your next match?"
                    ></textarea>
                  </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    id="cancelMatchBtn"
                  >
                    Cancel
                  </button>
                  <button type="submit" class="btn btn-primary">
                    Save Match
                  </button>
                </div>
              </form>
              </div>
            </div>
          </div>

          <!-- Match History -->
          <div id="matchHistory" class="match-section">
            <div class="section-card">
              <div class="section-header">
                <h2>Recent Matches</h2>
                <div class="filter-controls">
                  <select id="filterType" class="filter-select">
                    <option value="">All Match Types</option>
                    <option value="singles">Singles</option>
                    <option value="doubles">Doubles</option>
                    <option value="mixed-doubles">Mixed Doubles</option>
                  </select>
                  <select id="filterResult" class="filter-select">
                    <option value="">All Results</option>
                    <option value="win">Wins</option>
                    <option value="loss">Losses</option>
                  </select>
                  <select id="filterPeriod" class="filter-select">
                    <option value="all">All Time</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="3months">Last 3 Months</option>
                  </select>
                </div>
              </div>

              <div id="matchesList" class="matches-list">
                <div class="loading-state">
                  <div class="loading-content">
                    <span class="loading-icon">ÔøΩ</span>
                    <h3>Loading match history...</h3>
                    <p>Please wait while we fetch your match data</p>
                  </div>
                </div>
              </div>
              </div>
            </div>
          </div>

          <!-- Performance Analysis -->
          <div
            id="performanceAnalysis"
            class="match-section"
            style="display: none"
          >
            <div class="section-card">
              <h2>Performance Analysis</h2>
              <div class="analysis-grid">
                <div class="analysis-item">
                  <h3>Strengths</h3>
                  <div id="strengthsAnalysis" class="analysis-content">
                    <p>Record more matches to see your strengths!</p>
                  </div>
                </div>
                <div class="analysis-item">
                  <h3>Areas for Improvement</h3>
                  <div id="weaknessesAnalysis" class="analysis-content">
                    <p>
                      Record more matches to identify areas for improvement!
                    </p>
                  </div>
                </div>
                <div class="analysis-item">
                  <h3>Error Patterns</h3>
                  <div id="errorAnalysis" class="analysis-content">
                    <p>Error statistics will appear after recording matches!</p>
                  </div>
                </div>
                <div class="analysis-item">
                  <h3>Recommendations</h3>
                  <div id="recommendationsAnalysis" class="analysis-content">
                    <p>AI-powered recommendations coming soon!</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Success/Error Messages -->
    <div id="messageContainer" class="message-container"></div>

    <script src="js/common-ui.js"></script>
    <script>
      // Prevent auto init; we'll initialize after auth wiring
      window.shouldAutoInitMatches = false;
    </script>
    <script type="module">
      import { authService } from "./js/auth-service.js";
      import { dataService } from "./js/data-service.js";
      import { MatchManager } from "./js/matches.js"; // Import the class directly

      window.dataService = dataService;
      window.authService = authService;
      window.MatchManager = MatchManager; // Ensure it's available globally

      document.addEventListener("DOMContentLoaded", async () => {
        // Setup dropdown and sidebar via shared helpers
        if (typeof setupDropdown === "function") setupDropdown();
        if (typeof setupSidebar === "function") setupSidebar();

        // Set current date and default form date
        const today = new Date();
        document.getElementById("currentDate").textContent =
          today.toLocaleDateString("en-US", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          });
        const matchDateEl = document.getElementById("matchDate");
        if (matchDateEl) {
          matchDateEl.value = today.toISOString().split("T")[0];
        }

        // Wait briefly for auth state
        if (!authService.isAuthenticated()) {
          await new Promise((r) => setTimeout(r, 600));
        }

        const user = authService.getCurrentUser();
        if (!user) {
          window.location.href = "login.html";
          return;
        }

        // Set user for data service
        dataService.setCurrentUser(user.uid);

        // Load and display user's first name
        loadUserName("#userName");

        // Role-based sidebar
        const userRole = localStorage.getItem("userRole") || "player";
        if (userRole === "coach") {
          document.getElementById("playerSection").style.display = "none";
          document.getElementById("coachSection").style.display = "block";
        }

        // Initialize manager now that services are ready
        if (typeof MatchManager !== "undefined") {
          console.log("Creating MatchManager with services:", dataService, authService);
          window.matchManager = new MatchManager(dataService, authService);
          console.log("MatchManager created:", window.matchManager);
        } else {
          console.error("MatchManager not available");
        }

        // Logout button
        const signOutBtn = document.getElementById("signOutBtn");
        if (signOutBtn) {
          signOutBtn.addEventListener("click", async (e) => {
            e.preventDefault();
            if (!confirm("Are you sure you want to logout?")) return;
            const result = await authService.signOut();
            if (result.success) {
              window.location.href = "login.html";
            }
          });
        }

        // Back-compat still available via manager instance; CTA uses delegated handler now

        // Re-bind on auth change without requiring hard reload
        window.addEventListener("auth:changed", (e) => {
          const u = e.detail?.user;
          if (!u) return;
          dataService.setCurrentUser(u.uid);
          if (
            window.matchManager &&
            typeof window.matchManager.initialize === "function"
          ) {
            try {
              window.matchManager.initialize();
            } catch (_) {}
          } else if (typeof MatchManager !== "undefined") {
            // Re-create manager with updated services
            window.matchManager = new MatchManager(dataService, authService);
          }
        });
      });
    </script>
  </body>
</html>
